<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Network</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="css/network.css">
    <link href="https://fonts.googleapis.com/css?family=Josefin+Sans:400,700" rel="stylesheet">

    <script language="JavaScript">
        function httpPost(url, body, successCallback, errorCallback) {
            url = '/' + url;

            let xhr = new XMLHttpRequest();
            xhr.open('post', url, true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        successCallback();
                    } else if (errorCallback != null) {
                        errorCallback(xhr.status, xhr.statusText, xhr.responseText);
                    }
                }
            };

            xhr.send(body);
        }

        function httpGet(url, params, successCallback, errorCallback) {
            url = url + "?" + params;

            let xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        successCallback(xhr.responseText);
                    } else if (errorCallback != null) {
                        errorCallback(xhr.status, xhr.statusText, xhr.responseText);
                    }
                }
            };

            xhr.open('get', url, true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhr.send(null);
        }
    </script>
</head>
<body onresize="onPageResize()">

<div id="header">
    <div id="controlPanel">
        <input type="text" id="searchByStatusCode" class="default-input" onkeyup="onSearchByStatusCode(this)"
               placeholder="Status code" title="Type in a text">

        <span id="isShowOnlyErrorsWrapper">
            Only errors<br>
            <label id="isShowOnlyErrorsLabel" class="switch">
                <input id="isShowOnlyErrors" type="checkbox" onchange="onErrorSwitchChange(this)">
                <span class="check-box-slider check-box-round"></span>
            </label>
        </span>

        <div id="scrollControlPanel">
            <svg id="followButton" onclick="onFollowClick()" class="default-btn" height="28" viewBox="0 0 24 24" width="28"
                 xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" fill="none"></path>
                <path d="M12 5.83L15.17 9l1.41-1.41L12 3 7.41 7.59 8.83 9 12 5.83zm0 12.34L8.83 15l-1.41 1.41L12 21l4.59-4.59L15.17 15 12 18.17z"></path>
            </svg>
            <svg onclick="onGoTopClick()" class="default-btn with-padding" height="28" viewBox="0 0 24 24" width="28"
                 xmlns="http://www.w3.org/2000/svg">
                <path d="M12 8l-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14z"></path>
                <path d="M0 0h24v24H0z" fill="none"></path>
            </svg>
            <svg onclick="onGoBottomClick()" class="default-btn with-padding" height="28" viewBox="0 0 24 24" width="28"
                 xmlns="http://www.w3.org/2000/svg">
                <path d="M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6z"></path>
                <path d="M0 0h24v24H0z" fill="none"></path>
            </svg>
        </div>

        <svg onclick="onClearAllClick()" id="clearAllBtn" class="default-btn" height="28" viewBox="0 0 24 24"
             width="28" xmlns="http://www.w3.org/2000/svg">
            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM8 9h8v10H8V9zm7.5-5l-1-1h-5l-1 1H5v2h14V4z"></path>
            <path fill="none" d="M0 0h24v24H0V0z"></path>
        </svg>

        <div id="rightHeader">
            <a href="/" id="rightTitle">Home</a>

            <input type="text" id="changeContentFont" class="default-input" onkeyup="onChangeFont(this)"
                   placeholder="Size" title="Text size">
            <input type="text" id="searchLogs" class="default-input" onkeyup="onSearchLogs(this)"
                   placeholder="Search for text.." title="Type in a text">

            <div id="connectionStatus">Connected</div>

            <svg id="downloadLogs" class="default-btn" onclick="onDownloadLogs()" xmlns="http://www.w3.org/2000/svg"
                 width="31" height="31" viewBox="0 0 24 24">
                <path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2z"></path>
                <path fill="none" d="M0 0h24v24H0z"></path>
            </svg>

            <div id="theme">
                <svg id="darkTheme" onclick="onChangeThemeClick(true)" height="30" viewBox="0 0 24 24" width="30"
                     xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M0 0h24v24H0z" fill="none"></path>
                </svg>
                <svg id="lightTheme" onclick="onChangeThemeClick(false)" height="30" viewBox="0 0 24 24" width="30"
                     xmlns="http://www.w3.org/2000/svg">
                    <path fill="none" d="M0 0h24v24H0V0z"></path>
                    <path d="M12 4c4.41 0 8 3.59 8 8s-3.59 8-8 8-8-3.59-8-8 3.59-8 8-8m0-2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"></path>
                </svg>
            </div>
        </div>
    </div>
</div>

<div id="logContent">
    <div id="loader"></div>

    <table id="logTable">
    </table>
</div>

<div id="errorContent" class="error-content-dark-style">
    <pre id="errorText"></pre>

    <svg id="closeErrorContent" class="close-error-content-dark-style" onclick="onCloseErrorContentClick()" height="30"
         viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
        <path d="M19,6.41L17.59,5 12,10.59 6.41,5 5,6.41 10.59,12 5,17.59 6.41,19 12,13.41 17.59,19 19,17.59 13.41,12z"></path>
    </svg>

    <svg id="copyErrorContent" class="copy-error-content-white-style" onclick="onErrorTextClick()" height="23"
         viewBox="0 0 24 24" width="23" xmlns="http://www.w3.org/2000/svg">
        <path d="M16,1L4,1c-1.1,0 -2,0.9 -2,2v14h2L4,3h12L16,1zM19,5L8,5c-1.1,0 -2,0.9 -2,2v14c0,1.1 0.9,2 2,2h11c1.1,0 2,-0.9 2,-2L21,7c0,-1.1 -0.9,-2 -2,-2zM19,21L8,21L8,7h11v14z"></path>
    </svg>
    <span id="errorTextCopied" class="tooltip-text">Copied!</span>
</div>
</body>

<script>
    const REFRESH_TIME = 1000;
    const DEFAULT_FONT_SIZE = 12;
    const CONNECTION_LOST_MESSAGE = "Connection lost!";
    const COOKIE_LIFE_TIME = 15768000;

    let logsOffset = -1;
    let statusCode = null;
    let isOnlyError = false;
    let searchText = null;

    let logRequestLock = false;
    let timeoutHandle;
    let isFollowLogs = false;
    let isDarkTheme = true;

    let currentContentFont = DEFAULT_FONT_SIZE;
    let isConnectionLost = false;
    let receivedLogs = [];

    let logTable = getElementById("logTable");
    let changeContentFont = getElementById("changeContentFont");
    let lightTheme = getElementById("lightTheme");
    let darkTheme = getElementById("darkTheme");
    let logContent = getElementById("logContent");
    let connectionStatus = getElementById("connectionStatus");
    let loader = getElementById("loader");
    let errorContent = getElementById('errorContent');
    let errorText = getElementById('errorText');
    let rightHeader = getElementById('rightHeader');
    let header = getElementById('header');
    let copyErrorContent = getElementById('copyErrorContent');
    let errorTextCopied = getElementById('errorTextCopied');
    let closeErrorContent = getElementById('closeErrorContent');
    let searchByStatusCode = getElementById('searchByStatusCode');
    let followButton = getElementById('followButton');
    let headerRightDefaultY = rightHeader.offsetTop;

    window.onload = function () {
        loadLogs();
        loadDefaultsSetting();
        onPageResize();
    };

    // region Ui events
    function onErrorSwitchChange(item) {
        isOnlyError = item.checked;
        logsOffset = -1;

        if (isOnlyError) {
            searchByStatusCode.disabled = true;
            searchByStatusCode.classList.add("disable-input")
        } else {
            searchByStatusCode.disabled = false;
            searchByStatusCode.classList.remove("disable-input");
        }

        clearTimeoutHandle();
        loadLogs();
    }

    function onErrorTextClick() {
        copyToClipboard(errorText.innerHTML);
        visibleElement(errorTextCopied);

        let tooltipTimeout = setTimeout(function () {
            clearInterval(tooltipTimeout);
            invisibleElement(errorTextCopied);
        }, 800);
    }

    function onPageResize() {
        if (rightHeader.offsetTop > headerRightDefaultY + 18) {
            header.style.height = "130px";
            logContent.style.top = "131px";
            rightHeader.style.marginTop = "18px";
        } else {
            header.style.height = "80px";
            logContent.style.top = "81px";
            rightHeader.style.marginTop = "0px";
        }
    }

    function onFollowClick() {
        isFollowLogs = !isFollowLogs;
        saveDefaultsSetting();
        followLogs();
    }

    function followLogs() {
        if (isFollowLogs) {
            followButton.style.fill = '#ffb600';
            scrollToBottom();
        } else {
            followButton.style.fill = '#c9c9c9';
        }
    }

    function onGoTopClick() {
        scrollToTop();
    }

    function onGoBottomClick() {
        scrollToBottom();
    }

    function onChangeFont(item) {
        if (isNumeric(item.value)) {
            currentContentFont = item.value;
            setContentFont(currentContentFont);
            saveDefaultsSetting();
        }
    }

    function onSearchLogs(search) {
        logsOffset = -1;
        searchText = search.value;

        clearTimeoutHandle();
        loadLogs();
    }

    function onClearAllClick() {
        clearTimeoutHandle();

        clearContent(logTable);
        logsOffset = -1;

        let body = 'clearAllLogs=' + encodeURIComponent('');
        httpPost('network', body, function () {
            loadLogs();
        }, function (status, statusText, responseText) {
            failedConnection(status, statusText, responseText);
        });
    }

    function onDownloadLogs() {
        let time, queryId, body, i, fileName, totalText = "";
        let tr = logTable.getElementsByClassName("table-log-line");

        for (i = 0; i < tr.length; i++) {
            time = tr[i].getElementsByTagName("td")[0].innerText;
            queryId = tr[i].getElementsByTagName("td")[1].innerText;
            body = convertBodyToPlainText(tr[i].getElementsByTagName("td")[2]);

            totalText += time + ' \t' + queryId + ' \t' + body + "\n\n\n";
        }

        fileName = getCurrentTime() + '.txt';
        download(totalText, fileName, 'text/plain');
    }

    function convertBodyToPlainText(td) {
        let body = "";
        let queryType = "";
        let queryTypeItem = td.getElementsByClassName("query-type-name")[0];

        if (queryTypeItem) {
            queryType = queryTypeItem.innerText;
        }

        let queryDescription = "";
        let queryDescriptionItem = td.getElementsByClassName("query-description");
        for (let i = 0; i < queryDescriptionItem.length; i++) {
            if (queryDescriptionItem[i]) {
                queryDescription += queryDescriptionItem[i].innerText + "\n";
            }
        }

        let queryHeaders = "";
        let queryHeadersItem = td.getElementsByClassName("query-headers");
        for (let i = 0; i < queryHeadersItem.length; i++) {
            if (queryHeadersItem[i]) {
                queryHeaders += queryHeadersItem[i].innerText + "\n";
            }
        }

        let queryBody;
        let queryBodyItem = td.getElementsByClassName("query-body")[0];
        if (queryBodyItem) {
            queryBody = queryBodyItem.innerText;
        }


        body += queryType + "\n";
        body += queryDescription + "\n";

        if (queryHeaders.length !== 0) {
            body += "Headers:\n" + queryHeaders + "\n";
        }

        if (queryBody) {
            body += "Body:\n" + queryBody;
        }

        return body;
    }

    function onChangeThemeClick(isDark) {
        changeTheme(isDark);
        saveDefaultsSetting();
    }

    function onSearchByStatusCode(statusCodeInput) {
        statusCode = statusCodeInput.value;
        logsOffset = -1;

        clearTimeoutHandle();
        loadLogs();
    }

    function onCloseErrorContentClick() {
        clearContent(errorText);
        hideElement(errorContent);
    }

    // endregion

    // region Log loading
    function loadLogs() {
        if (isConnectionLost) {
            loadOfflineLogs();
            return;
        }

        if (logRequestLock) {
            return;
        }

        logRequestLock = true;

        let body = 'getLogs=' + encodeURIComponent('')
            + '&' + 'offset=' + encodeURIComponent(logsOffset)
            + '&' + 'isOnlyErrors=' + encodeURIComponent(isOnlyError.toString());

        if (statusCode != null) {
            body += '&' + 'statusCode=' + encodeURIComponent(statusCode);
        }

        if (searchText != null) {
            body += '&' + 'search=' + encodeURIComponent(searchText);
        }

        httpGet('network', body, function (response) {
            hideElement(loader);

            if (logsOffset === -1) {
                clearContent(logTable);
            }

            let parsedLogs = {};

            if (response !== '') {
                parsedLogs = JSON.parse(response);
            }

            if (parsedLogs.length !== 0) {
                if (logsOffset === -1) {
                    logsOffset = parsedLogs.length;

                    if (isInactiveSearch()) {
                        receivedLogs = [];
                    }
                } else {
                    logsOffset += parsedLogs.length;
                }

                buildLogsContent(parsedLogs, true);

                if (isFollowLogs) {
                    scrollToBottom();
                }
            }

            timeoutHandle = setTimeout(loadLogs, REFRESH_TIME);
            logRequestLock = false;
        }, function (status, statusText, responseText) {
            failedConnection(status, statusText, responseText);
        });
    }

    function buildLogsContent(logLines, isOnlineLogs) {
        let tbody = document.createElement("tbody");
        logTable.appendChild(tbody);

        logLines.forEach(function (logLine) {
            if (isOnlineLogs && isInactiveSearch()) {
                receivedLogs.push(logLine);
            }

            let tr = document.createElement("tr");

            if (isDarkTheme) {
                tr.className = "table-log-line table-log-line-dark-style";
            } else {
                tr.className = "table-log-line table-log-line-white-style";
            }

            tr.appendChild(timeTd(logLine));
            tr.appendChild(queryIdTd(logLine));
            tr.appendChild(bodyTd(logLine));

            tbody.appendChild(tr);
        });
    }

    function isInactiveSearch() {
        return (!isOnlyError && (statusCode == null || statusCode.length === 0) && (searchText == null || searchText.length === 0));
    }

    function isRequest(logLine) {
        return logLine.queryType === "REQUEST"
    }

    function isResponse(logLine) {
        return logLine.queryType === "RESPONSE"
    }

    function isErrorResponse(logLine) {
        return logLine.queryType === "RESPONSE" && (logLine.code >= 400 || logLine.errorMessage);
    }

    function setLogItemClassName(logLine, item) {
        if (isRequest(logLine)) {
            item.className = "primary-color-request";
        } else if (isErrorResponse(logLine)) {
            item.className = "primary-color-error-response";
        } else if (isResponse(logLine)) {
            item.className = "primary-color-response";
        }
    }

    function bodyTd(logLine) {
        let requestRootTd = document.createElement("td");
        let requestInfoDiv = document.createElement("div");
        let requestHeaderP = document.createElement("p");
        let requestLeftHeaderSpan = document.createElement("span");
        let requestCenterHeaderSpan = document.createElement("span");
        let requestRightHeaderSpan = document.createElement("span");

        requestRootTd.style.fontSize = currentContentFont + "pt";

        requestHeaderP.className = "main-query-title query-type-name";

        if (isDarkTheme) {
            requestRootTd.className = "log-item log-item-dark-style";
        } else {
            requestRootTd.className = "log-item log-item-white-style";
        }

        setLogItemClassName(logLine, requestCenterHeaderSpan);

        if (isRequest(logLine)) {
            requestLeftHeaderSpan.className = "log-type-secondary-request";
            requestRightHeaderSpan.className = "log-type-secondary-request";
        } else if (isErrorResponse(logLine)) {
            requestLeftHeaderSpan.className = "log-type-secondary-error-response";
            requestRightHeaderSpan.className = "log-type-secondary-error-response";
        } else if (isResponse(logLine)) {
            requestLeftHeaderSpan.className = "log-type-secondary-response";
            requestRightHeaderSpan.className = "log-type-secondary-response";
        }

        if (isRequest(logLine)) {
            requestLeftHeaderSpan.appendChild(document.createTextNode("░░░░░░░░░░░░░░"));
            requestCenterHeaderSpan.appendChild(document.createTextNode(" Request "));
            requestRightHeaderSpan.appendChild(document.createTextNode("░░░░░░░░░░░░░░"));
        } else if (isResponse(logLine)) {
            requestLeftHeaderSpan.appendChild(document.createTextNode("░░░░░░░░░░░░░░"));
            requestCenterHeaderSpan.appendChild(document.createTextNode(" Response "));
            requestRightHeaderSpan.appendChild(document.createTextNode("░░░░░░░░░░░░░░"));
        }

        requestHeaderP.appendChild(requestLeftHeaderSpan);
        requestHeaderP.appendChild(requestCenterHeaderSpan);
        requestHeaderP.appendChild(requestRightHeaderSpan);
        requestInfoDiv.appendChild(requestHeaderP);

        let urlP = document.createElement("p");
        urlP.className = "query-description";

        let urlSpan = document.createElement("span");
        let urlA = document.createElement("a");
        urlA.appendChild(document.createTextNode(logLine.url));
        urlA.target = "_blank";
        urlA.href = logLine.url;
        urlSpan.appendChild(document.createTextNode("URL: "));
        urlP.appendChild(urlSpan);
        urlP.appendChild(urlA);

        if (isDarkTheme) {
            urlA.className = "default-url log-header-url log-header-url-dark-style";
        } else {
            urlA.className = "default-url log-header-url log-header-url-white-style";
        }

        requestInfoDiv.appendChild(urlP);
        setLogItemClassName(logLine, urlSpan);

        let methodP = document.createElement("p");
        methodP.className = "query-description";

        let methodSpan = document.createElement("span");
        methodSpan.appendChild(document.createTextNode("Method: "));
        methodP.appendChild(methodSpan);
        methodP.appendChild(document.createTextNode(logLine.method));
        requestInfoDiv.appendChild(methodP);
        setLogItemClassName(logLine, methodSpan);

        if (logLine.ip) {
            let ipP = document.createElement("p");
            ipP.className = "query-description";

            let ipSpan = document.createElement("span");
            ipSpan.appendChild(document.createTextNode("Remote Address: "));
            ipP.appendChild(ipSpan);
            ipP.appendChild(document.createTextNode(logLine.fullIpAddress));
            requestInfoDiv.appendChild(ipP);
            setLogItemClassName(logLine, ipSpan);
        }

        if (isRequest(logLine) && logLine.requestContentType) {
            let contentTypeP = document.createElement("p");
            contentTypeP.className = "query-description";

            let contentTypeSpan = document.createElement("span");
            contentTypeSpan.className = "primary-color-request";
            contentTypeSpan.appendChild(document.createTextNode("Content-Type: "));
            contentTypeP.appendChild(contentTypeSpan);
            contentTypeP.appendChild(document.createTextNode(logLine.requestContentType));
            requestInfoDiv.appendChild(contentTypeP);
        }

        if (isResponse(logLine) && logLine.fullStatus) {
            let statusP = document.createElement("p");
            statusP.className = "query-description";

            let statusSpan = document.createElement("span");
            statusSpan.appendChild(document.createTextNode("Status: "));
            statusP.appendChild(statusSpan);
            statusP.appendChild(document.createTextNode(logLine.fullStatus));
            requestInfoDiv.appendChild(statusP);

            if (isErrorResponse(logLine)) {
                setLogItemClassName(logLine, statusP);
            } else {
                setLogItemClassName(logLine, statusSpan);
            }
        }

        if (isResponse(logLine) && logLine.duration) {
            let durationP = document.createElement("p");
            durationP.className = "query-description";

            let durationSpan = document.createElement("span");
            durationSpan.appendChild(document.createTextNode("Duration: "));
            durationP.appendChild(durationSpan);
            durationP.appendChild(document.createTextNode(logLine.duration));
            requestInfoDiv.appendChild(durationP);
            setLogItemClassName(logLine, durationSpan);
        }

        if (logLine.bodySize && logLine.bodySize !== 0 && logLine.bodySize !== -1) {
            let bodySizeP = document.createElement("p");
            bodySizeP.className = "query-description";

            let bodySizeSpan = document.createElement("span");
            bodySizeSpan.appendChild(document.createTextNode("Body size: "));
            bodySizeP.appendChild(bodySizeSpan);
            bodySizeP.appendChild(document.createTextNode(logLine.bodySize));
            requestInfoDiv.appendChild(bodySizeP);
            setLogItemClassName(logLine, bodySizeSpan);
        }

        if (isErrorResponse(logLine) && logLine.errorMessage) {
            let errorMessageP = document.createElement("p");
            errorMessageP.className = "query-description";

            let errorMessageSpan = document.createElement("span");
            errorMessageSpan.className = "primary-color-error-response";
            errorMessageSpan.appendChild(document.createTextNode("Error message: " + logLine.errorMessage));
            errorMessageP.appendChild(errorMessageSpan);
            requestInfoDiv.appendChild(errorMessageP);
        }

        requestInfoDiv.appendChild(document.createElement("br"));
        requestRootTd.appendChild(requestInfoDiv);

        if ((logLine.headers && logLine.headers.length !== 0) || logLine.body) {
            let requestBodyDiv = document.createElement("div");
            hideElement(requestBodyDiv);

            let detailSpan = document.createElement("span");
            detailSpan.innerHTML = "Show details";

            if (isRequest(logLine)) {
                requestBodyDiv.className = "log-content-border-request";
                detailSpan.className = "detail-log-item primary-color-request";
            } else if (isErrorResponse(logLine)) {
                requestBodyDiv.className = "log-content-border-error-response";
                detailSpan.className = "detail-log-item primary-color-error-response";
            } else if (isResponse(logLine)) {
                requestBodyDiv.className = "log-content-border-response";
                detailSpan.className = "detail-log-item primary-color-response";
            }

            detailSpan.onclick = function () {
                if (isVisibleElement(requestBodyDiv)) {
                    hideElement(requestBodyDiv);
                    detailSpan.innerHTML = "Show details";
                } else {
                    showElement(requestBodyDiv);
                    detailSpan.innerHTML = "Hide details";
                }
            };
            requestRootTd.appendChild(detailSpan);

            if (logLine.headers && logLine.headers.length !== 0) {
                let headersP = document.createElement("p");
                let headersSpan = document.createElement("span");
                headersSpan.appendChild(document.createTextNode("Headers:"));
                headersP.className = "default-item-space";
                headersP.appendChild(headersSpan);

                setLogItemClassName(logLine, headersSpan);

                requestBodyDiv.appendChild(document.createElement("br"));
                requestBodyDiv.appendChild(headersP);

                for (let i = 0; i < logLine.headers.length; i++) {
                    let headerP = document.createElement("p");
                    headerP.className = "default-item-space query-headers";
                    headerP.appendChild(document.createTextNode(logLine.headers[i]));
                    requestBodyDiv.appendChild(headerP);
                }

                if (logLine.body) {
                    requestBodyDiv.appendChild(document.createElement("br"));

                    let hr = document.createElement("hr");
                    requestBodyDiv.appendChild(hr);

                    if (isRequest(logLine)) {
                        hr.className = "default-hr hr-request";
                    } else if (isErrorResponse(logLine)) {
                        hr.className = "default-hr hr-error-response";
                    } else if (isResponse(logLine)) {
                        hr.className = "default-hr hr-response";
                    }
                }
            }

            if (logLine.body) {
                let bodyP = document.createElement("p");
                let bodySpan = document.createElement("span");
                bodySpan.appendChild(document.createTextNode("Body:"));
                bodyP.className = "default-item-space";
                bodyP.appendChild(bodySpan);
                setLogItemClassName(logLine, bodySpan);

                let bodyStr = getSimpleText(logLine.body);
                bodySpan.classList.add("detail-log-item");
                bodySpan.title = "Copy";
                bodySpan.onclick = function () {
                    copyToClipboard(bodyStr);
                };

                let bodyPre = document.createElement("pre");
                bodyPre.innerHTML = setBodyLinkable(bodyStr);
                bodyPre.className = "default-item-space query-body";

                requestBodyDiv.appendChild(document.createElement("br"));
                requestBodyDiv.appendChild(bodyP);
                requestBodyDiv.appendChild(bodyPre);
            }

            requestBodyDiv.appendChild(document.createElement("br"));
            requestRootTd.appendChild(requestBodyDiv);
        } else {
            let emptyBodySpan = document.createElement("span");
            emptyBodySpan.appendChild(document.createTextNode("Empty body"));
            requestRootTd.appendChild(emptyBodySpan);
            setLogItemClassName(logLine, emptyBodySpan);
        }

        return requestRootTd;
    }

    function queryIdTd(logLine) {
        let queryNumTd = document.createElement("td");
        let queryNumText = document.createTextNode(logLine.queryId);
        let queryNumClass = "";

        if (isDarkTheme) {
            queryNumClass = "log-item log-item-dark-style";
        } else {
            queryNumClass = "log-item log-item-white-style";
        }

        if (isRequest(logLine)) {
            queryNumClass += " primary-color-request";
        } else if (isErrorResponse(logLine)) {
            queryNumClass += " primary-color-error-response";
        } else if (isResponse(logLine)) {
            queryNumClass += " primary-color-response";
        }

        queryNumTd.setAttribute("class", queryNumClass);
        queryNumTd.style.fontSize = currentContentFont + "pt";
        queryNumTd.appendChild(queryNumText);
        return queryNumTd;
    }

    function timeTd(logLine) {
        let timeTd = document.createElement("td");
        let timeText = document.createTextNode(logLine.time);
        let timeClass = "";

        if (isDarkTheme) {
            timeClass = "log-item log-item-dark-style";
        } else {
            timeClass = "log-item log-item-white-style";
        }

        if (isRequest(logLine)) {
            timeClass += " primary-color-request";
        } else if (isErrorResponse(logLine)) {
            timeClass += " primary-color-error-response";
        } else if (isResponse(logLine)) {
            timeClass += " primary-color-response";
        }

        timeTd.setAttribute("class", timeClass);
        timeTd.style.fontSize = currentContentFont + "pt";
        timeTd.appendChild(timeText);
        return timeTd;
    }
    // endregion

    function loadDefaultsSetting() {
        let savedFont = getCookie('font');
        let savedIsDarkTheme = getCookie('isDarkTheme');
        let savedIsFollowLogs = getCookie('isFollowLogs');

        if (typeof savedFont === 'undefined') {
            currentContentFont = DEFAULT_FONT_SIZE;
        } else {
            currentContentFont = parseInt(savedFont);
        }

        if (typeof savedIsDarkTheme === 'undefined') {
            isDarkTheme = true;
        } else {
            isDarkTheme = savedIsDarkTheme === 'true';
        }

        if (typeof savedIsFollowLogs === 'undefined') {
            isFollowLogs = false;
        } else {
            isFollowLogs = savedIsFollowLogs === 'true';
        }

        changeTheme(isDarkTheme);
        setContentFont(currentContentFont);
        followLogs();

        if (DEFAULT_FONT_SIZE !== currentContentFont) {
            changeContentFont.value = currentContentFont;
        }
    }

    function saveDefaultsSetting() {
        setCookie('isDarkTheme', isDarkTheme, true);
        setCookie('font', currentContentFont, false);
        setCookie('isFollowLogs', isFollowLogs, false);
    }

    function setContentFont(fontSize) {
        let logItems = getElementsByClassName("log-item");
        for (let i = 0; i < logItems.length; i++) {
            logItems[i].style.fontSize = fontSize + "pt";
        }
    }

    function changeTheme(isDark) {
        isDarkTheme = isDark;

        let logLine = getElementsByClassName("table-log-line");
        for (let i = 0; i < logLine.length; i++) {
            if (isDarkTheme) {
                logLine[i].classList.remove("table-log-line-white-style");
                logLine[i].classList.add("table-log-line-dark-style");
            } else {
                logLine[i].classList.remove("table-log-line-dark-style");
                logLine[i].classList.add("table-log-line-white-style");
            }
        }

        let logContentUrls = getElementsByClassName("log-header-url");
        for (let i = 0; i < logContentUrls.length; i++) {
            if (isDarkTheme) {
                logContentUrls[i].classList.remove("log-header-url-white-style");
                logContentUrls[i].classList.add("log-header-url-dark-style");
            } else {
                logContentUrls[i].classList.remove("log-header-url-dark-style");
                logContentUrls[i].classList.add("log-header-url-white-style");
            }
        }

        let logItems = getElementsByClassName("log-item");
        for (let i = 0; i < logItems.length; i++) {
            if (isDarkTheme) {
                logItems[i].classList.remove("log-item-white-style");
                logItems[i].classList.add("log-item-dark-style");
            } else {
                logItems[i].classList.remove("log-item-dark-style");
                logItems[i].classList.add("log-item-white-style");
            }
        }

        if (isDarkTheme) {
            showElement(lightTheme);
            hideElement(darkTheme);
            logContent.style.backgroundColor = '#222';

            errorContent.classList.remove("error-content-white-style");
            errorContent.classList.add("error-content-dark-style");

            closeErrorContent.classList.remove("close-error-content-white-style");
            closeErrorContent.classList.add("close-error-content-dark-style");

            copyErrorContent.classList.remove("copy-error-content-white-style");
            copyErrorContent.classList.add("copy-error-content-dark-style");
        } else {
            hideElement(lightTheme);
            showElement(darkTheme);
            logContent.style.backgroundColor = '#fff';

            errorContent.classList.remove("error-content-dark-style");
            errorContent.classList.add("error-content-white-style");

            closeErrorContent.classList.remove("close-error-content-dark-style");
            closeErrorContent.classList.add("close-error-content-white-style");

            copyErrorContent.classList.remove("copy-error-content-dark-style");
            copyErrorContent.classList.add("copy-error-content-white-style");
        }
    }

    function failedConnection(status, statusText, responseText) {
        if (status === 0) {
            clearTimeoutHandle();
            isConnectionLost = true;

            connectionStatus.innerHTML = CONNECTION_LOST_MESSAGE;
            connectionStatus.style.color = '#e53935';

            let switcher = false;
            let backgroundInterval = setInterval(function () {
                if (!switcher) {
                    invisibleElement(connectionStatus);
                } else {
                    visibleElement(connectionStatus);
                }
                switcher = !switcher;
            }, 130);

            let backgroundTimeout = setTimeout(function () {
                clearInterval(backgroundInterval);
                clearTimeout(backgroundTimeout);
                visibleElement(connectionStatus);
            }, 1100);
        } else {
            showErrorMessage(status + " " + statusText + "\n" + responseText);
        }

        hideElement(loader)
    }

    function showErrorMessage(text) {
        errorText.innerHTML = text;
        showElement(errorContent);
    }

    function clearTimeoutHandle() {
        if (timeoutHandle) {
            clearTimeout(timeoutHandle);
        }
    }

    function loadOfflineLogs() {
        clearContent(logTable);

        let newLogsLines = [];

        receivedLogs.forEach(function (log) {
            let searchTextCheck = isSearchByText(log);
            let statusCodeCheck = isSearchByStatusCode(log);
            let onlyErrorCheck = isSearchByError(log);

            if (searchTextCheck) {
                if (isOnlyError) {
                    if (onlyErrorCheck) {
                        newLogsLines.push(log);
                    }
                } else {
                    if (statusCodeCheck) {
                        newLogsLines.push(log);
                    }
                }
            }
        });

        buildLogsContent(newLogsLines, false);
    }

    function isSearchByText(log) {
        let searchTextCheck = searchText == null || searchText === ""
            || (log.fullStatus && log.fullStatus.toLowerCase().indexOf(searchText.toLowerCase()) >= 0)
            || (log.duration && log.duration.toLowerCase().indexOf(searchText.toLowerCase()) >= 0)
            || (log.body && log.body.toLowerCase().indexOf(searchText.toLowerCase()) >= 0)
            || (log.bodySize && log.bodySize.toLowerCase().indexOf(searchText.toLowerCase()) >= 0)
            || (log.fullIpAddress && log.fullIpAddress.toLowerCase().indexOf(searchText.toLowerCase()) >= 0)
            || (log.method && log.method.toLowerCase().indexOf(searchText.toLowerCase()) >= 0)
            || (log.queryId && log.queryId.toLowerCase().indexOf(searchText.toLowerCase()) >= 0)
            || (log.requestContentType && log.requestContentType.toLowerCase().indexOf(searchText.toLowerCase()) >= 0)
            || (log.url && log.url.toLowerCase().indexOf(searchText.toLowerCase()) >= 0)
            || (log.errorMessage && log.errorMessage.toLowerCase().indexOf(searchText.toLowerCase()) >= 0)
            || (log.time && log.time.toLowerCase().indexOf(searchText.toLowerCase()) >= 0);

        if (!searchTextCheck && log.headers) {
            for (let i = 0; i < log.headers.length; i++) {
                searchTextCheck |= (log.headers[i]).toLowerCase().indexOf(searchText.toLowerCase()) >= 0;
            }
        }

        return searchTextCheck;
    }

    function isSearchByStatusCode(log) {
        let statusCodeCheck = statusCode == null || statusCode === "";
        if (!statusCodeCheck && statusCode != null && statusCode !== "") {
            let minStatusCode, maxStatusCode;
            let splitText = statusCode.split(/[ ,-]/);

            for (let i = 0; i < splitText.length; i++) {
                if (!isNumeric(splitText[i])) {
                    continue;
                }

                if (!minStatusCode) {
                    minStatusCode = parseInt(splitText[i], 10);
                } else if (!maxStatusCode) {
                    maxStatusCode = parseInt(splitText[i], 10);
                } else {
                    break;
                }
            }

            if (minStatusCode && !maxStatusCode) {
                maxStatusCode = minStatusCode;
            }

            if (minStatusCode && maxStatusCode) {
                statusCodeCheck = (log.code && log.code >= minStatusCode && log.code <= maxStatusCode);
            }
        }
        return statusCodeCheck;
    }

    function isSearchByError(log) {
        let onlyErrorCheck = !isOnlyError;
        if (!onlyErrorCheck) {
            if (log.code) {
                onlyErrorCheck = (log.code >= 400 && log.code <= 599);
            }

            if (log.errorMessage) {
                onlyErrorCheck = true;
            }
        }
        return onlyErrorCheck;
    }

    // region Utils
    function getCurrentTime() {
        let currentDate = new Date();
        return currentDate.getDate() + "."
            + (currentDate.getMonth() + 1) + "."
            + currentDate.getFullYear() + " @ "
            + currentDate.getHours() + "."
            + currentDate.getMinutes() + "."
            + currentDate.getSeconds() + "."
            + currentDate.getUTCMilliseconds() + ".";
    }

    function download(data, filename, type) {
        let file = new Blob([data], {type: type});
        if (window.navigator.msSaveOrOpenBlob) // IE10+
            window.navigator.msSaveOrOpenBlob(file, filename);
        else { // Others
            let a = document.createElement("a"),
                url = URL.createObjectURL(file);
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            setTimeout(function () {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 0);
        }
    }

    function setBodyLinkable(inputText) {
        let replacePattern1 = /(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim;
        return inputText.replace(replacePattern1, '<a href="$1" class="log-body-url" target="_blank">$1</a>');
    }

    function copyToClipboard(text) {
        copyTextToClipboard(text);
    }

    function copyTextToClipboard(text) {
        if (navigator.clipboard) {
            navigator.clipboard.writeText(text);
        } else {
            let textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                document.execCommand('copy');
            } finally {
                document.body.removeChild(textArea);
            }
        }
    }

    function scrollToBottom() {
        logContent.scrollTo(0, logTable.scrollHeight);
    }

    function scrollToTop() {
        logContent.scrollTo(0, 0);
    }

    function clearContent(element) {
        element.innerHTML = '';
    }

    function getElementById(id) {
        return document.getElementById(id);
    }

    function getElementsByClassName(name) {
        return document.getElementsByClassName(name);
    }

    function showElement(element) {
        element.style.display = "block";
    }

    function hideElement(element) {
        element.style.display = "none";
    }

    function isVisibleElement(element) {
        return element.style.display === "block"
    }

    function invisibleElement(element) {
        element.style.visibility = "hidden";
    }

    function visibleElement(element) {
        element.style.visibility = "visible";
    }

    function isNumeric(str) {
        return /^\d+$/.test(str);
    }

    function setCookie(name, value, isGlobal) {
        let path;
        if (isGlobal) {
            path = 'path=/';
        } else {
            path = 'path=/network';
        }

        document.cookie = encodeURIComponent(name) + "=" + encodeURIComponent(value) + "; "
            + path + "; "
            + "max-age=" + COOKIE_LIFE_TIME;
    }

    function getCookie(name) {
        let matches = document.cookie.match(new RegExp(
            "(?:^|; )" + name.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g, '\\$1') + "=([^;]*)"
        ));
        return matches ? decodeURIComponent(matches[1]) : undefined;
    }

    function getSimpleText(text) {
        return text.replace(/</g, '&lt;').replace(/>/g, '&gt;')
    }
    // endregion

</script>
</html>
